<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ .page.Title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://token.dcap.com/v1/client"></script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased">
    <div class="max-w-lg mx-auto p-4">
      <div class="bg-white border border-slate-200 rounded-xl shadow-lg overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-200">
          <h3 class="text-xl font-semibold">Choose a payment method</h3>
          <p class="text-sm text-slate-600 mt-1">Please select a payment method most convenient to you.</p>
        </div>

        <div class="p-5">
          <p class="font-semibold mb-3"><span class="font-bold">Amount:</span> {{ formatAmount .page.AmountCents .page.Currency }}</p>
          <div class="flex flex-col gap-3 mb-5">
            <label
              class="flex w-full flex-row sm:items-center justify-between gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer bg-white">
              <div class="flex flex-1 items-center justify-between">
                <input type="radio" name="method" id="method-credit" value="credit" checked class="h-5 w-5 accent-violet-600" />
              </div>
              <div class="flex items-center gap-1 w-[140px] sm:ml-auto">
                <div class="w-8 h-5 rounded bg-blue-600 text-white text-[10px] font-bold flex items-center justify-center">VISA</div>
                <div class="w-8 h-5 rounded relative flex items-center justify-center">
                  <div class="w-3 h-3 rounded-full bg-red-500 opacity-90 absolute left-1"></div>
                  <div class="w-3 h-3 rounded-full bg-orange-400 absolute left-3.5"></div>
                </div>
                <div class="w-8 h-5 rounded bg-slate-800 text-white text-[10px] font-bold flex items-center justify-center">AMEX</div>
                <div class="w-8 h-5 rounded bg-orange-500 text-white text-[10px] font-bold flex items-center justify-center">DISC</div>
              </div>
            </label>

            <label
              id="method-apple-wrapper"
              class="hidden flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer bg-white">
              <div class="flex items-center gap-3">
                <input type="radio" name="method" id="method-apple" value="apple" class="h-5 w-5 accent-violet-600" />
                <span class="flex items-center gap-2">
                  <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor" aria-hidden="true">
                    <path
                      d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" />
                  </svg>
                  <span class="font-medium">Apple Pay</span>
                </span>
              </div>
              <div class="sm:ml-auto"></div>
            </label>
          </div>

          <div id="manual-section">
            <form id="payment_form" onsubmit="return false;" autocomplete="on" class="space-y-4">
              <div>
                <label for="cardNumber" class="block text-sm font-medium mb-1">Card number</label>
                <input
                  type="tel"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  data-token="card_number"
                  placeholder="**** **** **** ****"
                  autocomplete="cc-number"
                  required
                  class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                  <label for="expMonth" class="block text-sm font-medium mb-1">Expiry month</label>
                  <input
                    type="tel"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    data-token="exp_month"
                    placeholder="MM"
                    maxlength="2"
                    autocomplete="cc-exp-month"
                    required
                    class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
                </div>
                <div>
                  <label for="expYear" class="block text-sm font-medium mb-1">Expiry year</label>
                  <input
                    type="tel"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    data-token="exp_year"
                    placeholder="YYYY"
                    maxlength="4"
                    autocomplete="cc-exp-year"
                    required
                    class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
                </div>
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                  <label for="cvv" class="block text-sm font-medium mb-1">Security code</label>
                  <input
                    type="tel"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    data-token="cvv"
                    placeholder="CVC"
                    maxlength="4"
                    autocomplete="cc-csc"
                    required
                    class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
                </div>
                <div>
                  <label for="postal" class="block text-sm font-medium mb-1">Postal code</label>
                  <input
                    type="text"
                    data-token="postal_code"
                    placeholder="12345"
                    autocomplete="postal-code"
                    class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
                </div>
              </div>
              <div class="pt-1">
                <button
                  id="pay_button"
                  type="button"
                  class="w-full h-12 rounded-xl bg-violet-600 hover:bg-violet-700 text-white font-semibold">
                  Pay
                </button>
              </div>
              <p id="payment_errors" class="text-sm text-red-600"></p>
            </form>
            <p id="msg" class="text-sm text-slate-500 mt-1"></p>
          </div>

          <div id="apple-pay-section" class="hidden mt-3">
            <div id="apple-pay-button" class="mb-2"></div>
            <button id="pay-apple" class="w-full h-12 rounded-xl bg-violet-600 hover:bg-violet-700 text-white font-semibold hidden">
              Pay with Apple Pay
            </button>
            <p class="text-sm text-slate-500 mt-2">Not seeing Apple Pay? Use Safari on iOS 10+ or macOS 10.12+ with an active wallet.</p>
          </div>
        </div>
      </div>
      <div class="mt-6 text-center">
        <p class="text-sm text-slate-600">Want to share this page with others?</p>
        <img class="mx-auto mt-3 rounded-lg border border-slate-200 shadow-sm" src="/qr/{{ .page.MerchantID }}/{{ .page.PageUID }}" alt="Share QR code" />
      </div>
    </div>

    <div
      id="page-data"
      data-merchant-id="{{ .page.MerchantID }}"
      data-page-uid="{{ .page.PageUID }}"
      data-store-name="{{ .page.StoreName }}"
      data-amount-cents="{{ .page.AmountCents }}"
      data-currency="{{ .page.Currency }}"
      data-webtoken-mid="{{ .page.PublicToken }}"></div>

    <script>
      ;(function () {
        let el = document.getElementById("page-data")
        let merchantId = el.dataset.merchantId
        let pageUid = el.dataset.pageUid
        let storeName = el.dataset.storeName || "Store"
        let amountCents = parseInt(el.dataset.amountCents || "0", 10)
        let currency = el.dataset.currency || "USD"
        let applePayMid = el.dataset.applePayMid || ""
        let webTokenMid = el.dataset.webtokenMid || "";

        let chargeUrl = "/api/payments/" + merchantId + "/" + pageUid + "/charge"
        let tokenizeUrl = "/api/applepay/tokenize"

        let msg = document.getElementById("msg")
        function setMsg(text) {
          msg.textContent = text || ""
        }

        function handleChargeWithToken(datacapToken) {
          return fetch(chargeUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ datacap_token: datacapToken }),
          }).then(async function (res) {
            let body = {}
            try {
              body = await res.json()
            } catch (e) {}
            if (!res.ok) throw new Error((body && body.message) || "Charge failed")
            if (body && body.approved) {
              return "Approved: " + (body.message || "")
            }
            throw new Error("Declined: " + ((body && body.message) || ""))
          })
        }

        // manual card
        let payBtn = document.getElementById("pay_button")
        let paymentErrors = document.getElementById("payment_errors")
        function clearErrors() {
          paymentErrors.textContent = ""
        }
        payBtn.addEventListener("click", function () {
          clearErrors()
          setMsg("")
          payBtn.disabled = true
          if (!window.DatacapWebToken) {
            paymentErrors.textContent = "Token library unavailable"
            payBtn.disabled = false
            return
          }
          const tokenCallback = function (response) {
            payBtn.disabled = false
            setMsg("")

            if (!response) {
              paymentErrors.textContent = "No response from tokenization"
              return
            }
            if (response.Error) {
              paymentErrors.textContent = response.Error
              return
            }

            const token = response.Token || response.token || response.id
            if (!token) {
              paymentErrors.textContent = "No token returned"
              return
            }

            try {
              const last4 = response.Last4 || response.last4 || response.cardLast4 || undefined
              const brand = response.Brand || response.brand || response.CardBrand || undefined
              console.log("[Datacap] Tokenization response:", response)
            } catch (_) {}
            handleChargeWithToken(token)
              .then(function (ok) {
                setMsg(ok)
              })
              .catch(function (err) {
                setMsg("Error: " + (err && err.message ? err.message : String(err)))
              })
          }
          console.log("requesting token")
          DatacapWebToken.requestToken(webTokenMid, "payment_form", tokenCallback)
        })

        // toggle between methods
        let methodCredit = document.getElementById("method-credit")
        let methodApple = document.getElementById("method-apple")
        let methodAppleWrapper = document.getElementById("method-apple-wrapper")
        let manualSection = document.getElementById("manual-section")
        let appleSection = document.getElementById("apple-pay-section")

        function applyMethodUI() {
          if (methodApple && methodApple.checked) {
            manualSection.classList.add("hidden")
            appleSection.classList.remove("hidden")
          } else {
            appleSection.classList.add("hidden")
            manualSection.classList.remove("hidden")
          }
        }
        ;[methodCredit, methodApple].forEach(function (el) {
          if (el) el.addEventListener("change", applyMethodUI)
        })

        // only shows if applicable
        let payAppleBtn = document.getElementById("pay-apple")
        function initApplePay() {
          try {
            let hasApplePay = !!window.ApplePaySession
            let hasDatacap = !!window.DatacapApplePay
            console.log("hasApplePay", hasApplePay)
            console.log("hasDatacap", hasDatacap)
            console.log("applePayMid", applePayMid)
            if (!(hasApplePay && hasDatacap && applePayMid)) {
              methodAppleWrapper.classList.add("hidden")
              appleSection.classList.add("hidden")
              methodCredit.checked = true
              applyMethodUI()
              return
            }
            methodAppleWrapper.classList.remove("hidden")
            const tokenCallback = function (tokenResponse) {
              return new Promise(function (resolve, reject) {
                if (!tokenResponse || tokenResponse.Error) {
                  reject(new Error("Token error: " + (tokenResponse && tokenResponse.Error)))
                  return
                }
                let token = tokenResponse.Token || tokenResponse.token || tokenResponse.id
                if (!token) {
                  reject(new Error("No token returned"))
                  return
                }
                handleChargeWithToken(token)
                  .then(function (ok) {
                    resolve(ok)
                  })
                  .catch(function (err) {
                    reject(err)
                  })
              })
            }
            DatacapApplePay.init(tokenCallback, applePayMid, storeName, "com.dcap.wallet", (amountCents / 100).toFixed(2))
            payAppleBtn.classList.add("hidden")
          } catch (e) {
            if (applePayMid) {
              methodAppleWrapper.classList.remove("hidden")
              payAppleBtn.classList.remove("hidden")
            } else {
              methodAppleWrapper.classList.add("hidden")
            }
          }
          applyMethodUI()
        }

        payAppleBtn.addEventListener("click", async function () {
          setMsg("")
          try {
            let tRes = await fetch(tokenizeUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token: { paymentData: { dummy: true } } }),
            })
            if (!tRes.ok) throw new Error("Tokenize failed")
            let tBody = await tRes.json()
            let datacapToken = tBody.datacap_token || tBody.token || tBody.id || tBody.value || "sample-token"
            setMsg("Processing...")
            let ok = await handleChargeWithToken(datacapToken)
            setMsg(ok)
          } catch (e) {
            setMsg("Error: " + (e && e.message ? e.message : String(e)))
          }
        })

        initApplePay()
      })()
    </script>
  </body>
</html>
