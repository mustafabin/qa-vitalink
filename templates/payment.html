<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ .page.Title }}</title>
    <meta name="description" content="{{ .page.Description }}">
    <meta property="og:title" content="{{ .page.Title }}">
    <meta property="og:description" content="{{ .page.Description }}">
    {{ if .page.Logo }}<meta property="og:image" content="{{ .page.Logo }}">{{ end }}
    {{ if .page.FavIcon }}<link rel="icon" href="{{ .page.FavIcon }}" />{{ end }}
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://token.dcap.com/v1/client"></script>
    <script src="https://wallet.dcap.com/v1/client/applepay"></script>
    <script src="https://wallet.dcap.com/v1/client/googlepay"></script>
    <script src="https://pay.google.com/gp/p/js/pay.js"></script>
    <script src="https://wallet.dcap.com/v2/client/googlepay"></script>
    <script src="https://wallet.dcap.com/v2/view/testGoogle"></script>

  </head>
  <body class="bg-slate-50 text-slate-900 antialiased">
    <div class="max-w-md mx-auto p-4">
      <div class="bg-white border border-slate-200 rounded-2xl shadow-xl overflow-hidden">
        {{ if .page.FeatureGraphic }}
        <div class="h-32 sm:h-40 md:h-48 w-full overflow-hidden bg-slate-100">
          <img src="{{ .page.FeatureGraphic }}" alt="Feature graphic" class="w-full h-full object-cover" />
        </div>
        {{ end }}
        <div class="px-6 py-6">
          {{ if .page.Logo }}
          <div class="flex justify-center mb-4">
            <img src="{{ .page.Logo }}" alt="Logo" class="h-16 w-auto" />
          </div>
          {{ end }}
          <div class="text-center">
            <div class="mx-auto mb-3 flex h-10 w-10 items-center justify-center rounded-full bg-slate-100 text-slate-600">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
                <path fill-rule="evenodd" d="M6.75 3A2.25 2.25 0 0 0 4.5 5.25v13.5A2.25 2.25 0 0 0 6.75 21h10.5A2.25 2.25 0 0 0 19.5 18.75V5.25A2.25 2.25 0 0 0 17.25 3H6.75Zm.75 3a.75.75 0 0 0 0 1.5h9a.75.75 0 0 0 0-1.5h-9Zm-.75 4.5c0-.414.336-.75.75-.75h9a.75.75 0 0 1 0 1.5h-9a.75.75 0 0 1-.75-.75Zm.75 3.75a.75.75 0 0 0 0 1.5h5.25a.75.75 0 0 0 0-1.5H7.5Z" clip-rule="evenodd" />
              </svg>
            </div>
            <p id="receipt-date" class="text-xs text-slate-500 mt-1"></p>
          </div>

          {{ if .page.Items }}
          <div class="mt-6 rounded-xl bg-slate-50 p-4 border border-slate-200">
            <h4 class="text-sm font-semibold mb-1">Items</h4>
            <div id="items_list" class="text-sm text-slate-700 space-y-1"></div>
          </div>
          {{ end }}

          <div class="mt-6 rounded-xl bg-slate-50 p-4 border border-slate-200">
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-600">Amount due</span>
              <span class="font-mono text-xl font-semibold">{{ formatAmount .page.AmountCents .page.Currency }}</span>
            </div>
            <div class="mt-2 text-[11px] text-slate-500">
              Page ID: {{ .page.PageUID }}
            </div>

          </div>

          <div class="mt-6 pt-6 border-t border-dashed border-slate-300">
            <h3 class="text-sm font-semibold mb-3">Payment method</h3>
            <div class="flex flex-col gap-3">
              <label
                class="flex w-full flex-row sm:items-center justify-between gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer bg-white">
                <div class="flex flex-1 items-center justify-between">
                  <input type="radio" name="method" id="method-credit" value="credit" checked class="h-5 w-5 accent-violet-600" />
                </div>
                <div class="flex items-center gap-1 w-[140px] sm:ml-auto">
                  <div class="w-8 h-5 rounded bg-blue-600 text-white text-[10px] font-bold flex items-center justify-center">VISA</div>
                  <div class="w-8 h-5 rounded relative flex items-center justify-center">
                    <div class="w-3 h-3 rounded-full bg-red-500 opacity-90 absolute left-1"></div>
                    <div class="w-3 h-3 rounded-full bg-orange-400 absolute left-3.5"></div>
                  </div>
                  <div class="w-8 h-5 rounded bg-slate-800 text-white text-[10px] font-bold flex items-center justify-center">AMEX</div>
                  <div class="w-8 h-5 rounded bg-orange-500 text-white text-[10px] font-bold flex items-center justify-center">DISC</div>
                </div>
              </label>

              <label
                id="method-apple-wrapper"
                class="hidden flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer bg-white">
                <div class="flex items-center gap-3">
                  <input type="radio" name="method" id="method-apple" value="apple" class="h-5 w-5 accent-violet-600" />
                  <span class="flex items-center gap-2">
                    <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor" aria-hidden="true">
                      <path
                        d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" />
                    </svg>
                    <span class="font-medium">Apple Pay</span>
                  </span>
                </div>
                <div class="sm:ml-auto"></div>
              </label>
            </div>
          </div>

          <div id="manual-section" class="mt-4">
            <form id="payment_form" onsubmit="return false;" autocomplete="on" class="space-y-4">
              <div>
                <label for="cardNumber" class="block text-sm font-medium mb-1">Card number</label>
                <input
                  type="tel"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  data-token="card_number"
                  placeholder="**** **** **** ****"
                  autocomplete="cc-number"
                  required
                  class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                  <label for="expMonth" class="block text-sm font-medium mb-1">Expiry month</label>
                  <input
                    type="tel"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    data-token="exp_month"
                    placeholder="MM"
                    maxlength="2"
                    autocomplete="cc-exp-month"
                    required
                    class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
                </div>
                <div>
                  <label for="expYear" class="block text-sm font-medium mb-1">Expiry year</label>
                  <input
                    type="tel"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    data-token="exp_year"
                    placeholder="YYYY"
                    maxlength="4"
                    autocomplete="cc-exp-year"
                    required
                    class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
                </div>
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                  <label for="cvv" class="block text-sm font-medium mb-1">Security code</label>
                  <input
                    type="tel"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    data-token="cvv"
                    placeholder="CVC"
                    maxlength="4"
                    autocomplete="cc-csc"
                    required
                    class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
                </div>
                <div>
                  <label for="postal" class="block text-sm font-medium mb-1">Postal code</label>
                  <input
                    type="text"
                    data-token="postal_code"
                    placeholder="12345"
                    autocomplete="postal-code"
                    class="h-12 w-full rounded-xl border border-slate-200 px-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-300 focus:border-violet-600" />
                </div>
              </div>
              <div class="pt-1">
                <button
                  id="pay_button"
                  type="button"
                  class="w-full h-12 rounded-xl bg-violet-600 hover:bg-violet-700 text-white font-semibold inline-flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
                  aria-busy="false"
                  aria-live="polite">
                  <svg id="pay_btn_spinner" class="hidden h-5 w-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                  </svg>
                  <span id="pay_btn_text">Pay</span>
                </button>
              </div>
              <p id="payment_errors" class="text-sm font-semibold text-red-700" role="alert" aria-live="polite"></p>
            </form>
            <p id="msg" class="text-sm text-slate-500 mt-1"></p>
          </div>

          <div id="apple-pay-section" class="mt-3">
            <div id="apple-pay-button" class="mt-2"></div>
            <p class="text-sm text-slate-500 mt-2">Not seeing Apple Pay? Use Safari on iOS 10+ or macOS 10.12+ with an active wallet.</p>
          </div>
          <div id="google-pay-section" class="mt-3">
            <div id="google-pay-button" class="mb-2"></div>
        </div>
      </div>

      <div class="mt-6 text-center">
        <p class="text-xs text-slate-600">Share this page</p>
        <img class="mx-auto mt-3 rounded-lg border border-slate-200 shadow-sm" src="/qr/{{ .page.MerchantID }}/{{ .page.PageUID }}" alt="Share QR code" />
      </div>
    </div>

    <div
      id="page-data"
      data-merchant-id="{{ .page.MerchantID }}"
      data-page-uid="{{ .page.PageUID }}"
      data-store-name="{{ .page.StoreName }}"
      data-amount-cents="{{ .page.AmountCents }}"
      data-currency="{{ .page.Currency }}"
      data-webtoken-mid="{{ .page.PublicToken }}"
      data-apple-pay-mid="{{ .page.ApplePayMid }}"
      data-google-pay-mid="{{ .page.GooglePayMid }}"
      data-created-at-utc="{{ .page.CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}"
      data-items-json='{{ .page.Items }}'></div>

    <script>
        let el = document.getElementById("page-data")
        let merchantId = el.dataset.merchantId
        let pageUid = el.dataset.pageUid
        let storeName = el.dataset.storeName || "Store"
        let amountCents = parseInt(el.dataset.amountCents || "0", 10)
        let currency = el.dataset.currency || "USD"
        let applePayMid = el.dataset.applePayMid || ""
        let googlePayMid = el.dataset.googlePayMid || ""
        let webTokenMid = el.dataset.webtokenMid || ""



        let chargeUrl = "/api/payments/" + merchantId + "/" + pageUid + "/charge"

        try {
          let dateEl = document.getElementById("receipt-date")
          let createdAtUtc = el.dataset.createdAtUtc
          if (dateEl && createdAtUtc) {
            let d = new Date(createdAtUtc)
            if (!isNaN(d.getTime())) {
              dateEl.textContent = d.toLocaleString()
            }
          }
        } catch (_) {}

        try {
          let itemsRoot = document.getElementById("items_list")
          let itemsJSON = el.dataset.itemsJson
          if (itemsRoot && itemsJSON) {
            let arr = JSON.parse(itemsJSON)
            if (Array.isArray(arr)) {
              itemsRoot.innerHTML = arr.map(function (it) {
                let title = (it && it.title) || ""
                let desc = (it && it.description) || ""
                let price = (it && it.price) || 0
                return `<div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium">${title}</div>
                    <div class="text-[12px] text-slate-500">${desc}</div>
                  </div>
                  <div class="font-mono text-sm">${(Number(price) / 100).toFixed(2)}</div>
                </div>`
              }).join("")
            }
          }
        } catch (_) {}

        let msg = document.getElementById("msg")
        function setMsg(text) {
          msg.textContent = text || ""
          if (text && /^Error:/i.test(text)) {
            msg.classList.remove("text-slate-500")
            msg.classList.add("font-semibold", "text-red-700")
          } else {
            msg.classList.remove("font-semibold", "text-red-700")
            msg.classList.add("text-slate-500")
          }
          if (text && typeof text === "string" && /^Approved:/i.test(text)) {
            try { window.location.reload() } catch (_) {}
          }
        }

        function handleChargeWithToken(datacapToken, last4, brand) {
          return fetch(chargeUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ datacap_token: datacapToken, last4: last4, brand: brand }),
          }).then(async function (res) {
            let body = {}
            try {
              body = await res.json()
            } catch (e) {}
            if (!res.ok) throw new Error((body && body.message) || "Charge failed")
            if (body && body.approved) {
              return "Approved: " + (body.message || "")
            }
            throw new Error("Declined: " + ((body && body.message) || ""))
          })
        }

        // manual card
        let payBtn = document.getElementById("pay_button")
        let payBtnSpinner = document.getElementById("pay_btn_spinner")
        let payBtnText = document.getElementById("pay_btn_text")
        let paymentErrors = document.getElementById("payment_errors")
        function clearErrors() {
          paymentErrors.textContent = ""
        }
        function setPayLoading(isLoading) {
          try {
            if (!payBtn) return
            payBtn.disabled = !!isLoading
            payBtn.setAttribute("aria-busy", isLoading ? "true" : "false")
            if (payBtnSpinner) payBtnSpinner.classList.toggle("hidden", !isLoading)
            if (payBtnText) payBtnText.textContent = isLoading ? "Processing..." : "Pay"
          } catch (_) {}
        }
        const tokenCallback = function (response) {
          setPayLoading(false)
          setMsg("")

          if (!response) {
            paymentErrors.textContent = "No response from tokenization"
            return
          }
          if (response.Error) {
            paymentErrors.textContent = response.Error
            return
          }

          const token = response.Token || response.token || response.id
          if (!token) {
            paymentErrors.textContent = "No token returned"
            return
          }

          let last4;
          let brand;
          try {
            last4 = response.Last4 || response.last4 || response.cardLast4 || undefined
            brand = response.Brand || response.brand || response.CardBrand || undefined
            console.log("[Datacap] Tokenization response:", response)
          } catch (_) {}
          handleChargeWithToken(token, last4, brand)
            .then(function (ok) {
              setMsg(ok)
            })
            .catch(function (err) {
              setMsg("Error: " + (err && err.message ? err.message : String(err)))
            })
            .finally(function () {
              setPayLoading(false)
            })
        }
        payBtn.addEventListener("click", function () {
          if (payBtn.disabled || payBtn.getAttribute("aria-busy") === "true") return
          clearErrors()
          setMsg("")
          setPayLoading(true)
          if (!window.DatacapWebToken) {
            paymentErrors.textContent = "Token library unavailable"
            setPayLoading(false)
            return
          }
          console.log("requesting token")
          DatacapWebToken.requestToken(webTokenMid, "payment_form", tokenCallback)
        })

        // toggle between methods
        let methodCredit = document.getElementById("method-credit")
        let methodApple = document.getElementById("method-apple")
        let methodAppleWrapper = document.getElementById("method-apple-wrapper")
        let manualSection = document.getElementById("manual-section")
        
    </script>
     <script>
        console.log("Apple Pay MID:", applePayMid)
        console.log("Google Pay MID:", googlePayMid)
        console.log("Web Token MID:", webTokenMid)
        console.log("Amount cents:", amountCents)
        console.log("merchantId:", merchantId)
        DatacapApplePay.init(tokenCallback, webTokenMid ,merchantId, applePayMid,(amountCents / 100).toFixed(2))
        // dont have google pay mid yet
        DatacapGooglePay.init(tokenCallback, webTokenMid ,merchantId,googlePayMid,(amountCents / 100).toFixed(2))
    </script>
  </body>
</html>
